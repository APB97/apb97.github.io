@implements IReadyable
@implements IDisposable
@typeparam T
@inject StringLocalizer<T> Localizer

@ChildContent(this)

@if (!ShouldRender())
{
    <div class="progress progress-bar progress-bar-animated progress-bar-striped" />
}

@code {
    private static Dictionary<Type, StringLocalizer<T>> localization = new Dictionary<Type, StringLocalizer<T>>();

    [Parameter]
    public required RenderFragment<LocalizedComponent<T>> ChildContent { get; set; }

    [CascadingParameter]
    public required MainLayout Layout { get; set; }

    public bool IsReady { get; private set; }

    public bool IsLoading => !IsReady;

    [Parameter]
    public Action OnReady { get; set; } = delegate { };

    [Parameter]
    public EventCallback<string> GetAdditionalResources { get; set; }

    public string this[string key] => Localizer[key];

    protected override bool ShouldRender()
    {
        if (!Localizer.IsReady) return false;
        return base.ShouldRender();
    }

    protected override void OnInitialized()
    {
        OnReady = StateHasChanged;
        Layout.OnStateChanging += GetResourcesAndRefreshComponentAsync;
    }

    protected override async Task OnInitializedAsync()
    {
        await GetResourcesAndRefreshComponentAsync();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (!IsReady && Localizer.IsReady)
        {
            IsReady = true;
            OnReady();
        }
    }

    public void Dispose()
    {
        Layout.OnStateChanging -= GetResourcesAndRefreshComponentAsync;
    }

    public async Task ReloadResourcesAndRefreshLayoutAsync()
    {
        await ReloadResourcesAsync();
        await Layout.NotifyStateChanged();
    }

    private async Task GetResourcesAndRefreshComponentAsync()
    {
        await ReloadResourcesAsync();   
        StateHasChanged();
    }

    private async Task ReloadResourcesAsync()
    {
        if (localization.TryGetValue(typeof(T), out var localizer) && localizer.Culture == LanguageSelect.Culture)
        {
            Localizer = localizer;
        }
        else
        {
            await Localizer.InitializeAsync(Layout.Culture);
            localization[typeof(T)] = Localizer;
            await GetAdditionalResources.InvokeAsync(Layout.Culture);
        }
    }
}
