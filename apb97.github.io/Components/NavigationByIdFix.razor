@implements IAsyncDisposable
@inject IJSRuntime JS

@code{
    private IJSObjectReference? module;

    protected override async Task OnInitializedAsync()
    {
        module = await JS.ImportAsync("./Components/NavigationByIdFix.razor.js");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await ActivateCurrentLink();
    }

    public async Task ActivateCurrentLink()
    {
        if (module is null) return;
        await module.InvokeVoidAsync("activateCurrentLink", null, null);
    }

    public async Task ScrollToElementFixAsync(NavigationManager navigation, string url, int msDelay = 25, CancellationToken cancellationToken = default)
    {
        await ScrollToElement(url);
        while (navigation is not null && !navigation.Uri.EndsWith(url))
            await Task.Delay(25, cancellationToken);
        await Task.Delay(msDelay, cancellationToken);
        await ScrollToElement(url);
    }

    public async Task ScrollToElement(string url)
    {
        if (module is null) return;
        await module.InvokeVoidAsync("scrollToElement", url);
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (module is null) return;
        await module.DisposeAsync();
    }
}